<script>
    // --- CONFIGURACIÓN Y VARIABLES GLOBALES ---
    const { jsPDF } = window.jspdf;
    const ESTADOS_REPUESTO = ['Solicitado a CEDIS', 'En Bodega Costa Verde', 'Despachado a Taller', 'Pedido Especial', 'En Revision por el CEDIS', 'Facturado'];
    let trabajos = [];
    let repuestos = [];
    let historialEstados = [];
    let chartEstados, chartModelos, chartClientes;
    let invitadoChartEstados, invitadoChartProgreso;
    let idRepuestoEnEdicion = null;
    let usuarioActual = null;
    let connectedUsers = [];
    
    // Configuración de Google Sheets API
    const API_KEY = 'AIzaSyCNP34eVXC-5XMs3-zKJ71bO7856NTBPYc'; // API key proporcionada
    const SPREADSHEET_ID = '1udqJTS1E7Wl7j5q8h2FWPyElXEl2Aom59Hwns4oCGw0'; // ID de la hoja de cálculo
    const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let lastSyncTime = 0;
    let syncInterval;
    let userActivityInterval;
    
    // Modo de almacenamiento (local o google sheets)
    const USE_LOCAL_STORAGE = false; // Cambiado a false para usar Google Sheets
    
    // --- INICIALIZACIÓN DE GOOGLE API ---
    function gapiLoaded() {
        if (!USE_LOCAL_STORAGE) {
            gapi.load('client', initializeGapiClient);
        } else {
            gapiInited = true;
            console.log('Modo local activado. Google API no se inicializará.');
        }
    }

    async function initializeGapiClient() {
        if (USE_LOCAL_STORAGE) return;
        
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS,
        });
        gapiInited = true;
        maybeEnableButtons();
    }

    function gisLoaded() {
        if (USE_LOCAL_STORAGE) {
            gisInited = true;
            console.log('Modo local activado. Google Identity Services no se inicializará.');
        } else {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '921169094128-g9i6hvrmo988nh10o3920urn3anbsh6k.apps.googleusercontent.com', // Client ID para OAuth 2.0
                scope: SCOPES,
                callback: '', // definido más tarde
            });
            gisInited = true;
            maybeEnableButtons();
        }
    }

    function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            // Las API están listas para usar
            console.log('Google APIs inicializadas correctamente');
        }
    }

    // --- FUNCIONES DE GOOGLE SHEETS ---
    async function authenticateGoogle() {
        if (USE_LOCAL_STORAGE) return Promise.resolve();
        
        return new Promise((resolve, reject) => {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    reject(resp);
                } else {
                    resolve();
                }
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        });
    }

    async function saveDataToGoogleSheets() {
        if (USE_LOCAL_STORAGE) {
            return Promise.resolve();
        }
        
        try {
            showSyncIndicator('Sincronizando con Google Sheets...', 'syncing');
            
            // Preparar los datos para guardar
            const data = {
                trabajos: trabajos,
                repuestos: repuestos,
                historialEstados: historialEstados,
                lastModified: new Date().toISOString(),
                connectedUsers: connectedUsers
            };
            
            // Convertir los datos a formato de hoja de cálculo
            const jsonData = JSON.stringify(data);
            
            // Actualizar la hoja de cálculo
            const response = await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Datos!A1',
                valueInputOption: 'RAW',
                resource: {
                    values: [[jsonData]]
                }
            });
            
            lastSyncTime = Date.now();
            showSyncIndicator('Datos sincronizados correctamente', 'success');
            setTimeout(hideSyncIndicator, 3000);
            
            return response;
        } catch (error) {
            console.error('Error al guardar datos en Google Sheets:', error);
            showSyncIndicator('Error al sincronizar datos', 'error');
            setTimeout(hideSyncIndicator, 5000);
            throw error;
        }
    }

    async function loadDataFromGoogleSheets() {
        if (USE_LOCAL_STORAGE) {
            return Promise.resolve(false);
        }
        
        try {
            showSyncIndicator('Cargando datos desde Google Sheets...', 'syncing');
            
            // Obtener los datos de la hoja de cálculo
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Datos!A1'
            });
            
            if (response.result.values && response.result.values.length > 0) {
                const jsonData = response.result.values[0][0];
                const data = JSON.parse(jsonData);
                
                // Actualizar los datos locales
                if (data.trabajos) trabajos = data.trabajos;
                if (data.repuestos) repuestos = data.repuestos;
                if (data.historialEstados) historialEstados = data.historialEstados;
                if (data.connectedUsers) connectedUsers = data.connectedUsers;
                
                lastSyncTime = Date.now();
                showSyncIndicator('Datos cargados correctamente', 'success');
                setTimeout(hideSyncIndicator, 3000);
                
                return true;
            } else {
                console.log('No se encontraron datos en la hoja de cálculo');
                hideSyncIndicator();
                return false;
            }
        } catch (error) {
            console.error('Error al cargar datos desde Google Sheets:', error);
            showSyncIndicator('Error al cargar datos', 'error');
            setTimeout(hideSyncIndicator, 5000);
            return false;
        }
    }

    function showSyncIndicator(text, status = 'syncing') {
        const indicator = document.getElementById('syncIndicator');
        const syncText = document.getElementById('syncText');
        
        syncText.textContent = text;
        indicator.className = 'sync-indicator show ' + status;
    }

    function hideSyncIndicator() {
        const indicator = document.getElementById('syncIndicator');
        indicator.className = 'sync-indicator';
    }

    // --- FUNCIONES DE USUARIOS CONECTADOS ---
    function registerUserActivity() {
        if (!usuarioActual) return;
        
        const userId = usuarioActual.nombre + '_' + Date.now();
        const userIndex = connectedUsers.findIndex(u => u.nombre === usuarioActual.nombre);
        
        if (userIndex === -1) {
            connectedUsers.push({
                id: userId,
                nombre: usuarioActual.nombre,
                rol: usuarioActual.rol,
                lastActivity: new Date().toISOString()
            });
        } else {
            connectedUsers[userIndex].lastActivity = new Date().toISOString();
        }
        
        updateConnectedUsersDisplay();
    }

    function updateConnectedUsersDisplay() {
        const now = new Date();
        const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);
        
        // Filtrar usuarios activos (con actividad en los últimos 5 minutos)
        const activeUsers = connectedUsers.filter(u => 
            new Date(u.lastActivity) > fiveMinutesAgo
        );
        
        const userCountElement = document.getElementById('userCount');
        const connectedUsersElement = document.getElementById('connectedUsers');
        
        if (activeUsers.length > 0) {
            userCountElement.textContent = `${activeUsers.length} usuario(s) conectado(s)`;
            connectedUsersElement.style.display = 'block';
        } else {
            connectedUsersElement.style.display = 'none';
        }
    }

    // --- SISTEMA DE LOGIN ---
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        if (username === 'admin' && password === 'admin') {
            usuarioActual = { rol: 'admin', nombre: 'Administrador' };
            iniciarAppAdmin();
        } else if (username === 'invitado' && password === 'invitado') {
            usuarioActual = { rol: 'invitado', nombre: 'Invitado' };
            iniciarAppInvitado();
        } else {
            mostrarNotificacion('Usuario o contraseña incorrectos.', 'error');
        }
    });

    async function iniciarAppAdmin() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminContainer').style.display = 'block';
        document.querySelector('#adminContainer h1').textContent += ` - Sesión de ${usuarioActual.nombre}`;
        
        // Cargar datos desde Google Sheets o localStorage
        if (!USE_LOCAL_STORAGE) {
            await loadDataFromGoogleSheets();
        }
        
        // Cargar datos locales como respaldo
        cargarDatosLocales();
        
        renderizarTrabajos();
        renderizarDashboard();
        actualizarSelectClientesReporte();
        
        // Registrar actividad del usuario
        registerUserActivity();
        
        // Iniciar sincronización automática cada 5 minutos solo si no estamos en modo local
        if (!USE_LOCAL_STORAGE) {
            syncInterval = setInterval(async () => {
                await loadDataFromGoogleSheets();
                renderizarTrabajos();
                renderizarDashboard();
            }, 5 * 60 * 1000);
            
            // Actualizar actividad del usuario cada minuto
            userActivityInterval = setInterval(() => {
                registerUserActivity();
                saveDataToGoogleSheets();
            }, 60 * 1000);
        }
    }

    async function iniciarAppInvitado() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('invitadoContainer').style.display = 'block';
        document.querySelector('.invitado-container h1').textContent += ` - Sesión de ${usuarioActual.nombre}`;
        
        // Cargar datos desde Google Sheets o localStorage
        if (!USE_LOCAL_STORAGE) {
            await loadDataFromGoogleSheets();
        }
        
        // Cargar datos locales como respaldo
        cargarDatosLocales();
        
        renderizarTrabajosInvitado();
        renderizarReportesInvitado();
        actualizarSelectTrabajosInvitado();
        actualizarSelectClientesReporteInvitado();
        
        // Registrar actividad del usuario
        registerUserActivity();
        
        // Iniciar sincronización automática cada 5 minutos solo si no estamos en modo local
        if (!USE_LOCAL_STORAGE) {
            syncInterval = setInterval(async () => {
                await loadDataFromGoogleSheets();
                renderizarTrabajosInvitado();
                renderizarReportesInvitado();
            }, 5 * 60 * 1000);
            
            // Actualizar actividad del usuario cada minuto
            userActivityInterval = setInterval(() => {
                registerUserActivity();
                saveDataToGoogleSheets();
            }, 60 * 1000);
        }
    }

    function cerrarSesion() {
        if (confirm('¿Está seguro de que desea cerrar sesión?')) {
            // Detener la sincronización automática
            if (syncInterval) clearInterval(syncInterval);
            if (userActivityInterval) clearInterval(userActivityInterval);
            
            // Guardar datos locales antes de cerrar sesión
            guardarDatosLocales();
            
            location.reload();
        }
    }

    // --- FUNCIONES AUXILIARES ---
    function formatearFecha(fechaISO) { 
        if (!fechaISO) return ''; 
        const fecha = new Date(fechaISO); 
        const dia = String(fecha.getDate()).padStart(2, '0'); 
        const mes = String(fecha.getMonth() + 1).padStart(2, '0'); 
        const anio = String(fecha.getFullYear()).slice(-2); 
        return `${dia}/${mes}/${anio}`; 
    }

    function formatearFechaHora(fechaISO) { 
        if (!fechaISO) return ''; 
        const fecha = new Date(fechaISO); 
        return fecha.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }); 
    }

    // --- FUNCIONES DE NOTIFICACIÓN ---
    function mostrarNotificacion(mensaje, tipo = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = mensaje;
        notification.className = `notification ${tipo}`;
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // --- FUNCIONES DE ALMACENAMIENTO LOCAL ---
    function cargarDatosLocales() {
        try {
            const trabajosData = localStorage.getItem('trabajos') ? JSON.parse(localStorage.getItem('trabajos')) : [];
            const repuestosData = localStorage.getItem('repuestos') ? JSON.parse(localStorage.getItem('repuestos')) : [];
            const historialData = localStorage.getItem('historialEstados') ? JSON.parse(localStorage.getItem('historialEstados')) : [];
            
            // Solo usar datos locales si no hay datos en la nube
            if (trabajos.length === 0) trabajos = trabajosData;
            if (repuestos.length === 0) repuestos = repuestosData;
            if (historialEstados.length === 0) historialEstados = historialData;
        } catch (error) {
            console.error("Error al cargar datos locales:", error);
            mostrarNotificacion("No se pudieron cargar los datos. Verifica tu conexión.", 'error');
        }
    }

    function guardarDatosLocales() {
        localStorage.setItem('trabajos', JSON.stringify(trabajos));
        localStorage.setItem('repuestos', JSON.stringify(repuestos));
        localStorage.setItem('historialEstados', JSON.stringify(historialEstados));
    }

    // --- FUNCIONES DE SINCRONIZACIÓN ---
    async function guardarDatos() {
        // Guardar en localStorage como respaldo
        guardarDatosLocales();
        
        // Intentar guardar en Google Sheets solo si no estamos en modo local
        if (!USE_LOCAL_STORAGE) {
            try {
                await saveDataToGoogleSheets();
                console.log('Datos guardados en Google Sheets');
                mostrarNotificacion('Datos guardados en Google Sheets', 'success');
            } catch (error) {
                console.error('Error al sincronizar con Google Sheets:', error);
                mostrarNotificacion('Error al sincronizar datos. Los cambios se guardarán localmente.', 'warning');
            }
        }
    }

    // --- FUNCIONES DEL ADMINISTRADOR ---
    function showTab(tabName) {
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(tab => tab.classList.remove('active'));
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => button.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if (tabName === 'trabajos') {
            renderizarTrabajos();
        } else if (tabName === 'ficha') {
            actualizarSelectTrabajoFicha();
        } else if (tabName === 'dashboard') {
            renderizarDashboard();
        }
    }

    // --- FUNCIONES DEL INVITADO ---
    function showInvitadoTab(tabName) {
        const tabContents = document.querySelectorAll('.invitado-tab-content');
        tabContents.forEach(tab => tab.classList.remove('active'));
        const tabButtons = document.querySelectorAll('.invitado-tab-button');
        tabButtons.forEach(button => button.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
        if (tabName === 'consulta') {
            renderizarTrabajosInvitado();
        } else if (tabName === 'reportes') {
            renderizarReportesInvitado();
        }
    }

    // --- FUNCIONES DE RENDERIZADO ---
    function renderizarTrabajos() {
        const tbody = document.querySelector('#tablaTrabajos tbody');
        tbody.innerHTML = '';
        
        trabajos.forEach(trabajo => {
            const row = document.createElement('tr');
            
            // Determinar clase de estado
            let estadoClass = '';
            if (trabajo.estado === 'Completado') estadoClass = 'invitado-status-completed';
            else if (trabajo.estado === 'En Proceso') estadoClass = 'invitado-status-pending';
            else estadoClass = 'invitado-status-delayed';
            
            row.innerHTML = `
                <td>${trabajo.numCotizacion}</td>
                <td>${formatearFecha(trabajo.fechaIngreso)}</td>
                <td>${trabajo.nombreCliente}</td>
                <td>${trabajo.placa}</td>
                <td>${trabajo.modeloVehiculo}</td>
                <td class="${estadoClass}">${trabajo.estado}</td>
                <td class="actions">
                    <button class="small-btn edit-btn" onclick="editarTrabajo('${trabajo.id}')">Editar</button>
                    <button class="small-btn delete-btn" onclick="eliminarTrabajo('${trabajo.id}')">Eliminar</button>
                    <button class="small-btn" onclick="verFichaTrabajo('${trabajo.id}')">Ver Ficha</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderizarTrabajosInvitado() {
        const tbody = document.querySelector('#tablaTrabajosInvitado tbody');
        tbody.innerHTML = '';
        
        trabajos.forEach(trabajo => {
            const repuestosTrabajo = repuestos.filter(r => r.idTrabajo === trabajo.id);
            const totalRepuestos = repuestosTrabajo.length;
            const repuestosRecibidos = repuestosTrabajo.filter(r => r.cantidadRecibida > 0).length;
            const progreso = totalRepuestos > 0 ? Math.round((repuestosRecibidos / totalRepuestos) * 100) : 0;
            
            // Determinar clase de estado
            let estadoClass = '';
            if (trabajo.estado === 'Completado') estadoClass = 'invitado-status-completed';
            else if (trabajo.estado === 'En Proceso') estadoClass = 'invitado-status-pending';
            else estadoClass = 'invitado-status-delayed';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trabajo.numCotizacion}</td>
                <td>${formatearFecha(trabajo.fechaIngreso)}</td>
                <td>${trabajo.nombreCliente}</td>
                <td>${trabajo.placa}</td>
                <td>${trabajo.modeloVehiculo}</td>
                <td class="${estadoClass}">${trabajo.estado}</td>
                <td>
                    <div style="background-color: #e0e0e0; border-radius: 4px; height: 20px; position: relative;">
                        <div style="background-color: #4caf50; height: 100%; width: ${progreso}%; border-radius: 4px;"></div>
                        <span style="position: absolute; top: 0; left: 0; width: 100%; text-align: center; line-height: 20px; color: #333; font-size: 12px;">${progreso}%</span>
                    </div>
                </td>
                <td class="actions">
                    <button class="small-btn" onclick="verDetallesTrabajoInvitado('${trabajo.id}')">Ver Detalles</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderizarDashboard() {
        // Calcular métricas
        const totalTrabajos = trabajos.length;
        const trabajosCompletados = trabajos.filter(t => t.estado === 'Completado').length;
        const efectividad = totalTrabajos > 0 ? Math.round((trabajosCompletados / totalTrabajos) * 100) : 0;
        
        const totalRepuestos = repuestos.length;
        const repuestosRecibidos = repuestos.filter(r => r.cantidadRecibida > 0).length;
        
        // Calcular tiempo promedio de espera
        let tiempoPromedio = 0;
        if (trabajos.length > 0) {
            const trabajosConFecha = trabajos.filter(t => t.fechaIngreso && t.fechaCompletado);
            if (trabajosConFecha.length > 0) {
                const totalDias = trabajosConFecha.reduce((sum, trabajo) => {
                    const ingreso = new Date(trabajo.fechaIngreso);
                    const completado = new Date(trabajo.fechaCompletado);
                    return sum + Math.floor((completado - ingreso) / (1000 * 60 * 60 * 24));
                }, 0);
                tiempoPromedio = Math.round(totalDias / trabajosConFecha.length);
            }
        }
        
        // Actualizar métricas en el DOM
        document.getElementById('metricEfectividad').textContent = `${efectividad}%`;
        document.getElementById('metricTrabajos').textContent = totalTrabajos;
        document.getElementById('metricRepuestos').textContent = totalRepuestos;
        document.getElementById('metricTiempoPromedio').textContent = tiempoPromedio;
        
        // Renderizar gráficos
        renderizarChartEstados();
        renderizarChartModelos();
        renderizarChartClientes();
        
        // Renderizar historial
        renderizarHistorial();
    }

    function renderizarChartEstados() {
        const ctx = document.getElementById('chartEstados').getContext('2d');
        const estadosCount = {
            'Pendiente': trabajos.filter(t => t.estado === 'Pendiente').length,
            'En Proceso': trabajos.filter(t => t.estado === 'En Proceso').length,
            'Completado': trabajos.filter(t => t.estado === 'Completado').length
        };
        
        if (chartEstados) chartEstados.destroy();
        chartEstados = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(estadosCount),
                datasets: [{
                    data: Object.values(estadosCount),
                    backgroundColor: ['#FF9800', '#2196F3', '#4CAF50']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trabajos por Estado'
                    }
                }
            }
        });
    }

    function renderizarChartModelos() {
        const ctx = document.getElementById('chartModelos').getContext('2d');
        const modelosCount = {};
        
        trabajos.forEach(trabajo => {
            if (!modelosCount[trabajo.modeloVehiculo]) {
                modelosCount[trabajo.modeloVehiculo] = 0;
            }
            modelosCount[trabajo.modeloVehiculo]++;
        });
        
        if (chartModelos) chartModelos.destroy();
        chartModelos = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(modelosCount),
                datasets: [{
                    label: 'Trabajos por Modelo',
                    data: Object.values(modelosCount),
                    backgroundColor: '#17a2b8'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trabajos por Modelo de Vehículo'
                    }
                }
            }
        });
    }

    function renderizarChartClientes() {
        const ctx = document.getElementById('chartClientes').getContext('2d');
        const clientesCount = {};
        
        trabajos.forEach(trabajo => {
            if (!clientesCount[trabajo.nombreCliente]) {
                clientesCount[trabajo.nombreCliente] = 0;
            }
            clientesCount[trabajo.nombreCliente]++;
        });
        
        // Ordenar clientes por cantidad de trabajos y tomar los 10 principales
        const sortedClientes = Object.entries(clientesCount)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        if (chartClientes) chartClientes.destroy();
        chartClientes = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedClientes.map(c => c[0]),
                datasets: [{
                    label: 'Trabajos por Cliente',
                    data: sortedClientes.map(c => c[1]),
                    backgroundColor: '#28a745'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 10 Clientes por Trabajos'
                    }
                }
            }
        });
    }

    function renderizarHistorial() {
        const tbody = document.querySelector('#tablaHistorial tbody');
        tbody.innerHTML = '';
        
        const filtro = document.getElementById('filtroHistorial').value.toLowerCase();
        const historialFiltrado = historialEstados.filter(h => 
            h.codigoRepuesto.toLowerCase().includes(filtro)
        );
        
        // Ordenar por fecha (más reciente primero)
        historialFiltrado.sort((a, b) => new Date(b.fechaCambio) - new Date(a.fechaCambio));
        
        historialFiltrado.forEach(historial => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatearFechaHora(historial.fechaCambio)}</td>
                <td>${historial.nombreCliente || '-'}</td>
                <td>${historial.codigoRepuesto}</td>
                <td>${historial.numCotizacion}</td>
                <td>${historial.estadoAnterior || '-'}</td>
                <td>${historial.estadoNuevo}</td>
                <td>${historial.cambiadoPor}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function renderizarReportesInvitado() {
        const totalTrabajos = trabajos.length;
        const totalRepuestos = repuestos.length;
        const repuestosRecibidos = repuestos.filter(r => r.cantidadRecibida > 0).length;
        const trabajosCompletados = trabajos.filter(t => t.estado === 'Completado').length;
        
        document.getElementById('invitadoTotalTrabajos').textContent = totalTrabajos;
        document.getElementById('invitadoRepuestosPendientes').textContent = totalRepuestos - repuestosRecibidos;
        document.getElementById('invitadoRepuestosRecibidos').textContent = repuestosRecibidos;
        document.getElementById('invitadoTrabajosCompletados').textContent = trabajosCompletados;
        
        renderizarInvitadoChartEstados();
        renderizarInvitadoChartProgreso();
    }

    function renderizarInvitadoChartEstados() {
        const ctx = document.getElementById('invitadoChartEstados').getContext('2d');
        const estadosCount = {
            'Pendientes': trabajos.filter(t => t.estado === 'Pendiente').length,
            'En Proceso': trabajos.filter(t => t.estado === 'En Proceso').length,
            'Completados': trabajos.filter(t => t.estado === 'Completado').length
        };
        
        if (invitadoChartEstados) invitadoChartEstados.destroy();
        invitadoChartEstados = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(estadosCount),
                datasets: [{
                    data: Object.values(estadosCount),
                    backgroundColor: ['#FF9800', '#2196F3', '#4CAF50']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trabajos por Estado'
                    }
                }
            }
        });
    }

    function renderizarInvitadoChartProgreso() {
        const ctx = document.getElementById('invitadoChartProgreso').getContext('2d');
        const estadosCount = {};
        
        ESTADOS_REPUESTO.forEach(estado => {
            estadosCount[estado] = repuestos.filter(r => r.estado === estado).length;
        });
        
        if (invitadoChartProgreso) invitadoChartProgreso.destroy();
        invitadoChartProgreso = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(estadosCount),
                datasets: [{
                    label: 'Repuestos por Estado',
                    data: Object.values(estadosCount),
                    backgroundColor: '#17a2b8'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Repuestos por Estado'
                    }
                }
            }
        });
    }

    // --- FUNCIONES DE ACTUALIZACIÓN DE SELECTS ---
    function actualizarSelectTrabajoFicha() {
        const select = document.getElementById('selectTrabajoFicha');
        select.innerHTML = '<option value="">-- Seleccione un trabajo --</option>';
        
        trabajos.forEach(trabajo => {
            const option = document.createElement('option');
            option.value = trabajo.id;
            option.textContent = `${trabajo.numCotizacion} - ${trabajo.nombreCliente}`;
            select.appendChild(option);
        });
        
        select.onchange = function() {
            if (this.value) {
                renderizarFichaTrabajo(this.value);
            } else {
                document.getElementById('contenidoFicha').innerHTML = '';
            }
        };
    }

    function actualizarSelectTrabajosInvitado() {
        const select = document.getElementById('selectTrabajoInvitado');
        select.innerHTML = '<option value="">-- Seleccione un trabajo --</option>';
        
        trabajos.forEach(trabajo => {
            const option = document.createElement('option');
            option.value = trabajo.id;
            option.textContent = `${trabajo.numCotizacion} - ${trabajo.nombreCliente}`;
            select.appendChild(option);
        });
        
        select.onchange = function() {
            if (this.value) {
                renderizarDetallesTrabajoInvitado(this.value);
            } else {
                document.getElementById('contenidoTrabajoInvitado').innerHTML = '';
            }
        };
    }

    function actualizarSelectClientesReporte() {
        const select = document.getElementById('selectClienteReporte');
        select.innerHTML = '<option value="">-- Seleccione un cliente --</option>';
        
        // Obtener lista única de clientes
        const clientesUnicos = [...new Set(trabajos.map(t => t.nombreCliente))];
        
        clientesUnicos.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente;
            option.textContent = cliente;
            select.appendChild(option);
        });
    }

    function actualizarSelectClientesReporteInvitado() {
        const select = document.getElementById('selectClienteReporteInvitado');
        select.innerHTML = '<option value="">-- Seleccione un cliente --</option>';
        
        // Obtener lista única de clientes
        const clientesUnicos = [...new Set(trabajos.map(t => t.nombreCliente))];
        
        clientesUnicos.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente;
            option.textContent = cliente;
            select.appendChild(option);
        });
    }

    // --- FUNCIONES DE DETALLES ---
    function renderizarFichaTrabajo(trabajoId) {
        const trabajo = trabajos.find(t => t.id === trabajoId);
        if (!trabajo) return;
        
        const repuestosTrabajo = repuestos.filter(r => r.idTrabajo === trabajoId);
        
        let html = `
            <div class="ficha-header">
                ${trabajo.imagenVehiculo ? `<img src="${trabajo.imagenVehiculo}" alt="Imagen del vehículo">` : ''}
                <div class="ficha-header-info">
                    <h3>${trabajo.numCotizacion} - ${trabajo.nombreCliente}</h3>
                    <p><strong>Placa:</strong> ${trabajo.placa}</p>
                    <p><strong>Modelo:</strong> ${trabajo.modeloVehiculo}</p>
                    <p><strong>Fecha de Ingreso:</strong> ${formatearFecha(trabajo.fechaIngreso)}</p>
                    <p><strong>Estado:</strong> ${trabajo.estado}</p>
                </div>
            </div>
            
            <div class="ficha-report-section">
                <h3>Lista de Repuestos</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th>Cantidad Cotizada</th>
                            <th>Cantidad Recibida</th>
                            <th>Estado</th>
                            <th>Fecha Recepción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        repuestosTrabajo.forEach(repuesto => {
            html += `
                <tr>
                    <td>${repuesto.codigoRepuesto}</td>
                    <td>${repuesto.descripcionRepuesto}</td>
                    <td>${repuesto.cantidadCotizada}</td>
                    <td>${repuesto.cantidadRecibida}</td>
                    <td>${repuesto.estado}</td>
                    <td>${formatearFecha(repuesto.fechaRecepcion)}</td>
                    <td class="actions">
                        <button class="small-btn edit-btn" onclick="editarRepuesto('${repuesto.id}')">Editar</button>
                        <button class="small-btn delete-btn" onclick="eliminarRepuesto('${repuesto.id}')">Eliminar</button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
                
                <div style="margin-top: 20px;">
                    <button onclick="agregarRepuesto('${trabajoId}')">Agregar Repuesto</button>
                </div>
            </div>
            
            <div class="ficha-report-section">
                <h3>Historial de Cambios</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Repuesto</th>
                            <th>Estado Anterior</th>
                            <th>Estado Nuevo</th>
                            <th>Cambiado por</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        const historialTrabajo = historialEstados.filter(h => {
            const repuesto = repuestos.find(r => r.id === h.idRepuesto);
            return repuesto && repuesto.idTrabajo === trabajoId;
        });
        
        // Ordenar por fecha (más reciente primero)
        historialTrabajo.sort((a, b) => new Date(b.fechaCambio) - new Date(a.fechaCambio));
        
        historialTrabajo.forEach(historial => {
            html += `
                <tr>
                    <td>${formatearFechaHora(historial.fechaCambio)}</td>
                    <td>${historial.codigoRepuesto}</td>
                    <td>${historial.estadoAnterior || '-'}</td>
                    <td>${historial.estadoNuevo}</td>
                    <td>${historial.cambiadoPor}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('contenidoFicha').innerHTML = html;
    }

    function renderizarDetallesTrabajoInvitado(trabajoId) {
        const trabajo = trabajos.find(t => t.id === trabajoId);
        if (!trabajo) return;
        
        const repuestosTrabajo = repuestos.filter(r => r.idTrabajo === trabajoId);
        const totalRepuestos = repuestosTrabajo.length;
        const repuestosRecibidos = repuestosTrabajo.filter(r => r.cantidadRecibida > 0).length;
        const progreso = totalRepuestos > 0 ? Math.round((repuestosRecibidos / totalRepuestos) * 100) : 0;
        
        let html = `
            <div class="invitado-detail-card">
                <div class="invitado-detail-header">
                    <h3>${trabajo.numCotizacion} - ${trabajo.nombreCliente}</h3>
                    <div style="background-color: #e0e0e0; border-radius: 4px; height: 30px; position: relative;">
                        <div style="background-color: #4caf50; height: 100%; width: ${progreso}%; border-radius: 4px;"></div>
                        <span style="position: absolute; top: 0; left: 0; width: 100%; text-align: center; line-height: 30px; color: #333; font-size: 12px; font-weight: bold;">${progreso}% Completado</span>
                    </div>
                </div>
                <div class="invitado-detail-info">
                    <div>
                        <p><strong>Placa:</strong> ${trabajo.placa}</p>
                        <p><strong>Modelo:</strong> ${trabajo.modeloVehiculo}</p>
                        <p><strong>Fecha de Ingreso:</strong> ${formatearFecha(trabajo.fechaIngreso)}</p>
                    </div>
                    <div>
                        <p><strong>Estado:</strong> ${trabajo.estado}</p>
                    </div>
                </div>
                <div class="invitado-detail-repuestos">
                    <h4>Lista de Repuestos</h4>
        `;
        
        repuestosTrabajo.forEach(repuesto => {
            let statusClass = 'pending';
            if (repuesto.estado === 'Facturado' || repuesto.cantidadRecibida >= repuesto.cantidadCotizada) {
                statusClass = 'completed';
            } else if (repuesto.estado === 'Pedido Especial' || repuesto.estado === 'En Revision por el CEDIS') {
                statusClass = 'delayed';
            }
            
            html += `
                <div class="invitado-repuesto-item">
                    <div class="invitado-repuesto-info">
                        ${repuesto.linkImagen ? `<img src="${repuesto.linkImagen}" alt="${repuesto.descripcionRepuesto}" class="invitado-repuesto-image" onclick="abrirModalImagen('${repuesto.linkImagen}')">` : ''}
                        <div>
                            <p><strong>${repuesto.codigoRepuesto}</strong> - ${repuesto.descripcionRepuesto}</p>
                            <p>Cantidad: ${repuesto.cantidadRecibida}/${repuesto.cantidadCotizada}</p>
                        </div>
                    </div>
                    <div class="invitado-repuesto-status ${statusClass}">${repuesto.estado}</div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
        
        document.getElementById('contenidoTrabajoInvitado').innerHTML = html;
    }

    // --- FUNCIONES DE BÚSQUEDA ---
    function buscarTrabajosInvitado() {
        const filtro = document.getElementById('busquedaInvitado').value.toLowerCase();
        const tbody = document.querySelector('#tablaTrabajosInvitado tbody');
        tbody.innerHTML = '';
        
        const trabajosFiltrados = trabajos.filter(trabajo => 
            trabajo.numCotizacion.toLowerCase().includes(filtro) ||
            trabajo.nombreCliente.toLowerCase().includes(filtro) ||
            trabajo.placa.toLowerCase().includes(filtro)
        );
        
        trabajosFiltrados.forEach(trabajo => {
            const repuestosTrabajo = repuestos.filter(r => r.idTrabajo === trabajo.id);
            const totalRepuestos = repuestosTrabajo.length;
            const repuestosRecibidos = repuestosTrabajo.filter(r => r.cantidadRecibida > 0).length;
            const progreso = totalRepuestos > 0 ? Math.round((repuestosRecibidos / totalRepuestos) * 100) : 0;
            
            // Determinar clase de estado
            let estadoClass = '';
            if (trabajo.estado === 'Completado') estadoClass = 'invitado-status-completed';
            else if (trabajo.estado === 'En Proceso') estadoClass = 'invitado-status-pending';
            else estadoClass = 'invitado-status-delayed';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${trabajo.numCotizacion}</td>
                <td>${formatearFecha(trabajo.fechaIngreso)}</td>
                <td>${trabajo.nombreCliente}</td>
                <td>${trabajo.placa}</td>
                <td>${trabajo.modeloVehiculo}</td>
                <td class="${estadoClass}">${trabajo.estado}</td>
                <td>
                    <div style="background-color: #e0e0e0; border-radius: 4px; height: 20px; position: relative;">
                        <div style="background-color: #4caf50; height: 100%; width: ${progreso}%; border-radius: 4px;"></div>
                        <span style="position: absolute; top: 0; left: 0; width: 100%; text-align: center; line-height: 20px; color: #333; font-size: 12px;">${progreso}%</span>
                    </div>
                </td>
                <td class="actions">
                    <button class="small-btn" onclick="verDetallesTrabajoInvitado('${trabajo.id}')">Ver Detalles</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function limpiarBusquedaInvitado() {
        document.getElementById('busquedaInvitado').value = '';
        renderizarTrabajosInvitado();
    }

    // --- FUNCIONES DE EXPORTACIÓN ---
    function exportarAExcel() {
        const workbook = XLSX.utils.book_new();
        
        // Hoja de trabajos
        const trabajosWS = XLSX.utils.json_to_sheet(trabajos);
        XLSX.utils.book_append_sheet(workbook, trabajosWS, "Trabajos");
        
        // Hoja de repuestos
        const repuestosWS = XLSX.utils.json_to_sheet(repuestos);
        XLSX.utils.book_append_sheet(workbook, repuestosWS, "Repuestos");
        
        // Hoja de historial
        const historialWS = XLSX.utils.json_to_sheet(historialEstados);
        XLSX.utils.book_append_sheet(workbook, historialWS, "Historial");
        
        XLSX.writeFile(workbook, "Sistema_Repuestos_Export.xlsx");
        mostrarNotificacion('Exportación a Excel completada.', 'success');
    }

    function generarReporteIndividualExcel() {
        const clienteSeleccionado = document.getElementById('selectClienteReporte').value;
        if (!clienteSeleccionado) {
            mostrarNotificacion('Por favor, seleccione un cliente.', 'warning');
            return;
        }
        
        // Filtrar trabajos por cliente
        const trabajosCliente = trabajos.filter(t => t.nombreCliente === clienteSeleccionado);
        
        if (trabajosCliente.length === 0) {
            mostrarNotificacion('No se encontraron trabajos para este cliente.', 'warning');
            return;
        }
        
        // Crear libro de Excel
        const workbook = XLSX.utils.book_new();
        
        // Hoja de resumen
        const resumenData = [
            [`Reporte de ${clienteSeleccionado}`],
            [`Fecha de generación: ${new Date().toLocaleDateString()}`],
            [],
            ['Total de Trabajos:', trabajosCliente.length],
            ['Total de Repuestos:', repuestos.filter(r => trabajosCliente.some(t => t.id === r.idTrabajo)).length],
            ['Repuestos Recibidos:', repuestos.filter(r => trabajosCliente.some(t => t.id === r.idTrabajo) && r.cantidadRecibida > 0).length],
            [],
            ['Trabajos del Cliente'],
            ['N° Cotización', 'Fecha', 'Placa', 'Modelo', 'Estado']
        ];
        
        trabajosCliente.forEach(trabajo => {
            resumenData.push([
                trabajo.numCotizacion,
                formatearFecha(trabajo.fechaIngreso),
                trabajo.placa,
                trabajo.modeloVehiculo,
                trabajo.estado
            ]);
        });
        
        const resumenWS = XLSX.utils.aoa_to_sheet(resumenData);
        XLSX.utils.book_append_sheet(workbook, resumenWS, "Resumen");
        
        // Hoja de repuestos
        const repuestosData = [['Repuestos del Cliente'], [], ['Código', 'Descripción', 'Cantidad Cotizada', 'Cantidad Recibida', 'Estado', 'Fecha Recepción', 'N° Cotización', 'Imagen']];
        
        trabajosCliente.forEach(trabajo => {
            const repuestosTrabajo = repuestos.filter(r => r.idTrabajo === trabajo.id);
            repuestosTrabajo.forEach(repuesto => {
                repuestosData.push([
                    repuesto.codigoRepuesto,
                    repuesto.descripcionRepuesto,
                    repuesto.cantidadCotizada,
                    repuesto.cantidadRecibida,
                    repuesto.estado,
                    formatearFecha(repuesto.fechaRecepcion),
                    trabajo.numCotizacion,
                    repuesto.linkImagen || ''
                ]);
            });
        });
        
        const repuestosWS = XLSX.utils.aoa_to_sheet(repuestosData);
        XLSX.utils.book_append_sheet(workbook, repuestosWS, "Repuestos");
        
        // Hoja de historial
        const historialData = [['Historial de Cambios'], [], ['Fecha y Hora', 'Repuesto', 'N° Cotización', 'Estado Anterior', 'Estado Nuevo', 'Cambiado por']];
        
        const idsTrabajosCliente = trabajosCliente.map(t => t.id);
        const historialCliente = historialEstados.filter(h => {
            const repuesto = repuestos.find(r => r.id === h.idRepuesto);
            return repuesto && idsTrabajosCliente.includes(repuesto.idTrabajo);
        });
        
        historialCliente.forEach(historial => {
            historialData.push([
                formatearFechaHora(historial.fechaCambio),
                historial.codigoRepuesto,
                historial.numCotizacion,
                historial.estadoAnterior || '-',
                historial.estadoNuevo,
                historial.cambiadoPor
            ]);
        });
        
        const historialWS = XLSX.utils.aoa_to_sheet(historialData);
        XLSX.utils.book_append_sheet(workbook, historialWS, "Historial");
        
        // Descargar el archivo
        XLSX.writeFile(workbook, `Reporte_${clienteSeleccionado.replace(/ /g, '_')}.xlsx`);
        mostrarNotificacion('Reporte generado correctamente.', 'success');
    }

    function generarReporteInvitadoExcel() {
        const clienteSeleccionado = document.getElementById('selectClienteReporteInvitado').value;
        if (!clienteSeleccionado) {
            mostrarNotificacion('Por favor, seleccione un cliente.', 'warning');
            return;
        }
        
        // Filtrar trabajos por cliente
        const trabajosCliente = trabajos.filter(t => t.nombreCliente === clienteSeleccionado);
        
        if (trabajosCliente.length === 0) {
            mostrarNotificacion('No se encontraron trabajos para este cliente.', 'warning');
            return;
        }
        
        // Crear libro de Excel
        const workbook = XLSX.utils.book_new();
        
        // Hoja de resumen
        const resumenData = [
            [`Reporte de ${clienteSeleccionado}`],
            [`Fecha de generación: ${new Date().toLocaleDateString()}`],
            [],
            ['Total de Trabajos:', trabajosCliente.length],
            ['Total de Repuestos:', repuestos.filter(r => trabajosCliente.some(t => t.id === r.idTrabajo)).length],
            ['Repuestos Recibidos:', repuestos.filter(r => trabajosCliente.some(t => t.id === r.idTrabajo) && r.cantidadRecibida > 0).length],
            [],
            ['Trabajos del Cliente'],
            ['N° Cotización', 'Fecha', 'Placa', 'Modelo', 'Estado']
        ];
        
        trabajosCliente.forEach(trabajo => {
            resumenData.push([
                trabajo.numCotizacion,
                formatearFecha(trabajo.fechaIngreso),
                trabajo.placa,
                trabajo.modeloVehiculo,
                trabajo.estado
            ]);
        });
        
        const resumenWS = XLSX.utils.aoa_to_sheet(resumenData);
        XLSX.utils.book_append_sheet(workbook, resumenWS, "Resumen");
        
        // Hoja de repuestos
        const repuestosData = [['Repuestos del Cliente'], [], ['Código', 'Descripción', 'Cantidad Cotizada', 'Cantidad Recibida', 'Estado', 'Fecha Recepción', 'N° Cotización', 'Imagen']];
        
        trabajosCliente.forEach(trabajo => {
            const repuestosTrabajo = repuestos.filter(r => r.idTrabajo === trabajo.id);
            repuestosTrabajo.forEach(repuesto => {
                repuestosData.push([
                    repuesto.codigoRepuesto,
                    repuesto.descripcionRepuesto,
                    repuesto.cantidadCotizada,
                    repuesto.cantidadRecibida,
                    repuesto.estado,
                    formatearFecha(repuesto.fechaRecepcion),
                    trabajo.numCotizacion,
                    repuesto.linkImagen || ''
                ]);
            });
        });
        
        const repuestosWS = XLSX.utils.aoa_to_sheet(repuestosData);
        XLSX.utils.book_append_sheet(workbook, repuestosWS, "Repuestos");
        
        // Hoja de historial
        const historialData = [['Historial de Cambios'], [], ['Fecha y Hora', 'Repuesto', 'N° Cotización', 'Estado Anterior', 'Estado Nuevo', 'Cambiado por']];
        
        const idsTrabajosCliente = trabajosCliente.map(t => t.id);
        const historialCliente = historialEstados.filter(h => {
            const repuesto = repuestos.find(r => r.id === h.idRepuesto);
            return repuesto && idsTrabajosCliente.includes(repuesto.idTrabajo);
        });
        
        historialCliente.forEach(historial => {
            historialData.push([
                formatearFechaHora(historial.fechaCambio),
                historial.codigoRepuesto,
                historial.numCotizacion,
                historial.estadoAnterior || '-',
                historial.estadoNuevo,
                historial.cambiadoPor
            ]);
        });
        
        const historialWS = XLSX.utils.aoa_to_sheet(historialData);
        XLSX.utils.book_append_sheet(workbook, historialWS, "Historial");
        
        // Descargar el archivo
        XLSX.writeFile(workbook, `Reporte_${clienteSeleccionado.replace(/ /g, '_')}.xlsx`);
        mostrarNotificacion('Reporte generado correctamente.', 'success');
    }

    function generarReporteIndividualPDF() {
        mostrarNotificacion("Funcionalidad de PDF en desarrollo. Use la exportación a Excel por ahora.", 'warning');
    }

    function generarReporteInvitadoPDF() {
        mostrarNotificacion("Funcionalidad de PDF para invitados en desarrollo. Use la exportación a Excel por ahora.", 'warning');
    }

    // --- FUNCIONES DE MODAL ---
    function abrirModalImagen(url) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        
        modal.style.display = 'block';
        modalImg.src = url;
    }

    function cerrarModalImagen() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // --- FUNCIONES DE EDICIÓN Y ELIMINACIÓN ---
    function editarTrabajo(trabajoId) {
        const trabajo = trabajos.find(t => t.id === trabajoId);
        if (!trabajo) return;
        
        // Llenar el formulario con los datos del trabajo
        document.getElementById('numCotizacion').value = trabajo.numCotizacion;
        document.getElementById('nombreCliente').value = trabajo.nombreCliente;
        document.getElementById('placa').value = trabajo.placa;
        document.getElementById('modeloVehiculo').value = trabajo.modeloVehiculo;
        document.getElementById('imagenVehiculo').value = trabajo.imagenVehiculo || '';
        
        // Cambiar el título del formulario
        document.querySelector('#trabajos h2').textContent = 'Editar Trabajo';
        
        // Cambiar el evento submit para actualizar en lugar de crear
        const form = document.getElementById('formTrabajo');
        form.onsubmit = async function(e) {
            e.preventDefault();
            
            // Actualizar los datos del trabajo
            trabajo.numCotizacion = document.getElementById('numCotizacion').value;
            trabajo.nombreCliente = document.getElementById('nombreCliente').value;
            trabajo.placa = document.getElementById('placa').value;
            trabajo.modeloVehiculo = document.getElementById('modeloVehiculo').value;
            trabajo.imagenVehiculo = document.getElementById('imagenVehiculo').value;
            
            // Guardar cambios
            await guardarDatos();
            renderizarTrabajos();
            
            // Restaurar el formulario para crear nuevos trabajos
            document.querySelector('#trabajos h2').textContent = 'Crear Nuevo Trabajo (Individual)';
            form.reset();
            form.onsubmit = handleFormTrabajoSubmit;
            
            mostrarNotificacion('Trabajo actualizado correctamente.', 'success');
        };
    }

    async function eliminarTrabajo(trabajoId) {
        if (!confirm('¿Está seguro de que desea eliminar este trabajo? También se eliminarán todos los repuestos asociados.')) {
            return;
        }
        
        // Eliminar el trabajo
        const trabajoIndex = trabajos.findIndex(t => t.id === trabajoId);
        if (trabajoIndex !== -1) {
            trabajos.splice(trabajoIndex, 1);
        }
        
        // Eliminar los repuestos asociados
        repuestos = repuestos.filter(r => r.idTrabajo !== trabajoId);
        
        // Eliminar el historial asociado
        const idsRepuestosAEliminar = repuestos.filter(r => r.idTrabajo === trabajoId).map(r => r.id);
        historialEstados = historialEstados.filter(h => !idsRepuestosAEliminar.includes(h.idRepuesto));
        
        // Guardar cambios
        await guardarDatos();
        renderizarTrabajos();
        
        mostrarNotificacion('Trabajo eliminado correctamente.', 'success');
    }

    function verFichaTrabajo(trabajoId) {
        // Cambiar a la pestaña de ficha
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        
        document.querySelector('button[onclick="showTab(\'ficha\')"]').classList.add('active');
        document.getElementById('ficha').classList.add('active');
        
        // Seleccionar el trabajo en el select
        document.getElementById('selectTrabajoFicha').value = trabajoId;
        
        // Renderizar la ficha
        renderizarFichaTrabajo(trabajoId);
    }

    function verDetallesTrabajoInvitado(trabajoId) {
        // Cambiar a la pestaña de detalles
        document.querySelectorAll('.invitado-tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.invitado-tab-content').forEach(tab => tab.classList.remove('active'));
        
        document.querySelector('button[onclick="showInvitadoTab(\'detalles\')"]').classList.add('active');
        document.getElementById('detalles').classList.add('active');
        
        // Seleccionar el trabajo en el select
        document.getElementById('selectTrabajoInvitado').value = trabajoId;
        
        // Renderizar los detalles
        renderizarDetallesTrabajoInvitado(trabajoId);
    }

    function agregarRepuesto(trabajoId) {
        // Crear un formulario para agregar un nuevo repuesto
        const trabajo = trabajos.find(t => t.id === trabajoId);
        if (!trabajo) return;
        
        const formHtml = `
            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3>Agregar Nuevo Repuesto</h3>
                <form id="formNuevoRepuesto">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="codigoRepuesto">Código del Repuesto:</label>
                            <input type="text" id="codigoRepuesto" required>
                        </div>
                        <div class="form-group">
                            <label for="cantidadCotizada">Cantidad Cotizada:</label>
                            <input type="number" id="cantidadCotizada" min="1" required>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="descripcionRepuesto">Descripción del Repuesto:</label>
                            <input type="text" id="descripcionRepuesto" required>
                        </div>
                        <div class="form-group">
                            <label for="cantidadRecibida">Cantidad Recibida:</label>
                            <input type="number" id="cantidadRecibida" min="0">
                        </div>
                        <div class="form-group">
                            <label for="estadoRepuesto">Estado:</label>
                            <select id="estadoRepuesto">
                                ${ESTADOS_REPUESTO.map(estado => `<option value="${estado}">${estado}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fechaRecepcion">Fecha de Recepción:</label>
                            <input type="date" id="fechaRecepcion">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="linkImagen">URL de la Imagen:</label>
                            <input type="url" id="linkImagen" placeholder="https://...">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="submit">Guardar Repuesto</button>
                        <button type="button" onclick="cancelarAgregarRepuesto()">Cancelar</button>
                    </div>
                </form>
            </div>
        `;
        
        // Agregar el formulario al DOM
        const container = document.createElement('div');
        container.innerHTML = formHtml;
        document.getElementById('contenidoFicha').appendChild(container);
        
        // Configurar el evento submit
        document.getElementById('formNuevoRepuesto').onsubmit = async function(e) {
            e.preventDefault();
            
            // Crear el nuevo repuesto
            const nuevoRepuesto = {
                id: 'REP-' + Date.now(),
                idTrabajo: trabajoId,
                numCotizacion: trabajo.numCotizacion,
                codigoRepuesto: document.getElementById('codigoRepuesto').value,
                descripcionRepuesto: document.getElementById('descripcionRepuesto').value,
                cantidadCotizada: parseInt(document.getElementById('cantidadCotizada').value),
                cantidadRecibida: parseInt(document.getElementById('cantidadRecibida').value) || 0,
                estado: document.getElementById('estadoRepuesto').value,
                fechaRecepcion: document.getElementById('fechaRecepcion').value,
                linkImagen: document.getElementById('linkImagen').value
            };
            
            // Agregar el repuesto a la lista
            repuestos.push(nuevoRepuesto);
            
            // Agregar al historial
            historialEstados.push({
                idHistorial: 'HIST-' + Date.now(),
                idRepuesto: nuevoRepuesto.id,
                numCotizacion: trabajo.numCotizacion,
                codigoRepuesto: nuevoRepuesto.codigoRepuesto,
                descripcionRepuesto: nuevoRepuesto.descripcionRepuesto,
                estadoAnterior: '',
                estadoNuevo: nuevoRepuesto.estado,
                fechaCambio: new Date().toISOString(),
                cambiadoPor: usuarioActual.nombre
            });
            
            // Guardar cambios
            await guardarDatos();
            
            // Actualizar la vista
            renderizarFichaTrabajo(trabajoId);
            
            mostrarNotificacion('Repuesto agregado correctamente.', 'success');
        };
    }

    function cancelarAgregarRepuesto() {
        // Eliminar el formulario de agregar repuesto
        const formContainer = document.querySelector('#contenidoFicha > div:last-child');
        if (formContainer && formContainer.querySelector('#formNuevoRepuesto')) {
            formContainer.remove();
        }
    }

    function editarRepuesto(repuestoId) {
        const repuesto = repuestos.find(r => r.id === repuestoId);
        if (!repuesto) return;
        
        const trabajo = trabajos.find(t => t.id === repuesto.idTrabajo);
        if (!trabajo) return;
        
        // Crear un formulario para editar el repuesto
        const formHtml = `
            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
                <h3>Editar Repuesto</h3>
                <form id="formEditarRepuesto">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="editCodigoRepuesto">Código del Repuesto:</label>
                            <input type="text" id="editCodigoRepuesto" value="${repuesto.codigoRepuesto}" required>
                        </div>
                        <div class="form-group">
                            <label for="editCantidadCotizada">Cantidad Cotizada:</label>
                            <input type="number" id="editCantidadCotizada" value="${repuesto.cantidadCotizada}" min="1" required>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="editDescripcionRepuesto">Descripción del Repuesto:</label>
                            <input type="text" id="editDescripcionRepuesto" value="${repuesto.descripcionRepuesto}" required>
                        </div>
                        <div class="form-group">
                            <label for="editCantidadRecibida">Cantidad Recibida:</label>
                            <input type="number" id="editCantidadRecibida" value="${repuesto.cantidadRecibida}" min="0">
                        </div>
                        <div class="form-group">
                            <label for="editEstadoRepuesto">Estado:</label>
                            <select id="editEstadoRepuesto">
                                ${ESTADOS_REPUESTO.map(estado => `<option value="${estado}" ${estado === repuesto.estado ? 'selected' : ''}>${estado}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editFechaRecepcion">Fecha de Recepción:</label>
                            <input type="date" id="editFechaRecepcion" value="${repuesto.fechaRecepcion}">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="editLinkImagen">URL de la Imagen:</label>
                            <input type="url" id="editLinkImagen" value="${repuesto.linkImagen || ''}" placeholder="https://...">
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="submit">Guardar Cambios</button>
                        <button type="button" onclick="cancelarEditarRepuesto()">Cancelar</button>
                    </div>
                </form>
            </div>
        `;
        
        // Agregar el formulario al DOM
        const container = document.createElement('div');
        container.innerHTML = formHtml;
        document.getElementById('contenidoFicha').appendChild(container);
        
        // Configurar el evento submit
        document.getElementById('formEditarRepuesto').onsubmit = async function(e) {
            e.preventDefault();
            
            // Guardar el estado anterior para el historial
            const estadoAnterior = repuesto.estado;
            
            // Actualizar los datos del repuesto
            repuesto.codigoRepuesto = document.getElementById('editCodigoRepuesto').value;
            repuesto.descripcionRepuesto = document.getElementById('editDescripcionRepuesto').value;
            repuesto.cantidadCotizada = parseInt(document.getElementById('editCantidadCotizada').value);
            repuesto.cantidadRecibida = parseInt(document.getElementById('editCantidadRecibida').value) || 0;
            repuesto.estado = document.getElementById('editEstadoRepuesto').value;
            repuesto.fechaRecepcion = document.getElementById('editFechaRecepcion').value;
            repuesto.linkImagen = document.getElementById('editLinkImagen').value;
            
            // Agregar al historial si el estado cambió
            if (estadoAnterior !== repuesto.estado) {
                historialEstados.push({
                    idHistorial: 'HIST-' + Date.now(),
                    idRepuesto: repuesto.id,
                    numCotizacion: trabajo.numCotizacion,
                    codigoRepuesto: repuesto.codigoRepuesto,
                    descripcionRepuesto: repuesto.descripcionRepuesto,
                    estadoAnterior: estadoAnterior,
                    estadoNuevo: repuesto.estado,
                    fechaCambio: new Date().toISOString(),
                    cambiadoPor: usuarioActual.nombre
                });
            }
            
            // Guardar cambios
            await guardarDatos();
            
            // Actualizar la vista
            renderizarFichaTrabajo(trabajo.id);
            
            mostrarNotificacion('Repuesto actualizado correctamente.', 'success');
        };
    }

    function cancelarEditarRepuesto() {
        // Eliminar el formulario de editar repuesto
        const formContainer = document.querySelector('#contenidoFicha > div:last-child');
        if (formContainer && formContainer.querySelector('#formEditarRepuesto')) {
            formContainer.remove();
        }
    }

    async function eliminarRepuesto(repuestoId) {
        if (!confirm('¿Está seguro de que desea eliminar este repuesto?')) {
            return;
        }
        
        const repuesto = repuestos.find(r => r.id === repuestoId);
        if (!repuesto) return;
        
        const trabajo = trabajos.find(t => t.id === repuesto.idTrabajo);
        if (!trabajo) return;
        
        // Eliminar el repuesto
        const repuestoIndex = repuestos.findIndex(r => r.id === repuestoId);
        if (repuestoIndex !== -1) {
            repuestos.splice(repuestoIndex, 1);
        }
        
        // Eliminar el historial asociado
        historialEstados = historialEstados.filter(h => h.idRepuesto !== repuestoId);
        
        // Guardar cambios
        await guardarDatos();
        
        // Actualizar la vista
        renderizarFichaTrabajo(trabajo.id);
        
        mostrarNotificacion('Repuesto eliminado correctamente.', 'success');
    }

    // --- MANEJADORES DE FORMULARIOS CORREGIDOS ---
    async function handleFormTrabajoSubmit(e) {
        e.preventDefault();
        const nuevoTrabajo = {
            id: 'TRAB-' + Date.now(),
            numCotizacion: document.getElementById('numCotizacion').value,
            fechaIngreso: new Date().toISOString(),
            nombreCliente: document.getElementById('nombreCliente').value,
            placa: document.getElementById('placa').value,
            modeloVehiculo: document.getElementById('modeloVehiculo').value,
            imagenVehiculo: document.getElementById('imagenVehiculo').value,
            estado: 'Pendiente'
        };
        trabajos.push(nuevoTrabajo);
        await guardarDatos();
        renderizarTrabajos();
        this.reset();
        mostrarNotificacion('Trabajo creado correctamente.', 'success');
    }

    async function handleFormTrabajoMasivoSubmit(e) {
        e.preventDefault();
        const nuevoTrabajo = {
            id: 'TRAB-' + Date.now(),
            numCotizacion: document.getElementById('numCotizacionMasivo').value,
            fechaIngreso: new Date().toISOString(),
            nombreCliente: document.getElementById('nombreClienteMasivo').value,
            placa: document.getElementById('placaMasivo').value,
            modeloVehiculo: document.getElementById('modeloVehiculoMasivo').value,
            imagenVehiculo: document.getElementById('imagenVehiculo').value,
            estado: 'Pendiente'
        };
        trabajos.push(nuevoTrabajo);
        
        const textoRepuestos = document.getElementById('textoRepuestosMasivosTrabajo').value;
        const lineas = textoRepuestos.split('\n');
        let contadorRepuestos = 0;
        
        lineas.forEach(linea => {
            const partes = linea.split('\t');
            if (partes.length >= 3) {
                const nuevoRepuesto = {
                    id: 'REP-' + Date.now() + Math.random(),
                    idTrabajo: nuevoTrabajo.id,
                    numCotizacion: nuevoTrabajo.numCotizacion,
                    codigoRepuesto: partes[0],
                    descripcionRepuesto: partes[1],
                    cantidadCotizada: parseInt(partes[2]),
                    cantidadRecibida: partes.length >= 4 ? parseInt(partes[3]) : 0,
                    estado: 'Solicitado a CEDIS',
                    fechaRecepcion: '',
                    link: '',
                    linkImagen: ''
                };
                repuestos.push(nuevoRepuesto);
                historialEstados.push({
                    idHistorial: 'HIST-' + Date.now() + Math.random(),
                    idRepuesto: nuevoRepuesto.id,
                    numCotizacion: nuevoTrabajo.numCotizacion,
                    codigoRepuesto: partes[0],
                    descripcionRepuesto: partes[1],
                    estadoAnterior: '',
                    estadoNuevo: 'Solicitado a CEDIS',
                    fechaCambio: new Date().toISOString(),
                    cambiadoPor: usuarioActual.nombre
                });
                contadorRepuestos++;
            }
        });
        
        await guardarDatos();
        renderizarTrabajos();
        this.reset();
        mostrarNotificacion(`Trabajo y ${contadorRepuestos} repuestos creados correctamente.`, 'success');
    }

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar las APIs de Google
        gapiLoaded();
        gisLoaded();
        
        // Configurar manejadores de eventos para los formularios
        document.getElementById('formTrabajo').addEventListener('submit', handleFormTrabajoSubmit);
        document.getElementById('formTrabajoMasivo').addEventListener('submit', handleFormTrabajoMasivoSubmit);
    });
</script>
